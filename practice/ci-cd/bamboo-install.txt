=========================================================
### https://confluence.atlassian.com/bamboo/bamboo-documentation-289276551.html

### script to install postgresql and bamboo:

sudo su
apt update

# install postgre:
sh -c 'echo "deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
apt-get update
apt-get -y install postgresql-16

# install java (jdk, not jre!):
apt install -y openjdk-17-jdk
# set enviroment variables:
cat << EOF >> .profile

export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export PATH=$PATH:$JAVA_HOME/bin
EOF

# Update the /etc/hosts file on the bamboo server:
echo "192.168.0.102   agent" >> /etc/hosts

# Create a dedicated user to run Bamboo:
useradd --create-home --home-dir /usr/local/bamboo -p $(perl -e 'print crypt($ARGV[0], "password")' pass123) --shell /bin/bash bamboo

# Create bamboo install folder:
mkdir -p /opt/bamboo-install && cd /opt/bamboo-install

# Download Bamboo:
# https://www.atlassian.com/software/bamboo/download-archives
wget -c https://www.atlassian.com/software/bamboo/downloads/binary/atlassian-bamboo-9.6.0.tar.gz
tar -zxf atlassian-bamboo-9.6.0.tar.gz

# Create bamboo home directory:
mkdir -p /opt/bamboo-home
echo "bamboo.home=/opt/bamboo-home/" >> /opt/bamboo-install/atlassian-bamboo-9.6.0/atlassian-bamboo/WEB-INF/classes/bamboo-init.properties

cd /opt
chown -R bamboo: bamboo-install/ bamboo-home/

-----------------------------------------------------

# Creating a Bamboo database:
sudo -s -H -u postgres
# Create the Bamboo user:
/usr/lib/postgresql/16/bin/createuser -S -d -r -P -E bamboouser
# Create the bamboo database:
/usr/lib/postgresql/16/bin/createdb -O bamboouser bamboo
exit

-----------------------------------------------------
su bamboo
# Start Bamboo: 
bash /opt/bamboo-install/atlassian-bamboo-9.6.0/bin/start-bamboo.sh

# If you want to stop bamboo:
bash /opt/bamboo-install/atlassian-bamboo-9.6.0/bin/stop-bamboo.sh

# bamboo logs:
cat /opt/bamboo-home/logs/atlassian-bamboo.log
-----------------------------------------------------

# Running Bamboo as a Linux service:
# https://confluence.atlassian.com/bamboo/running-bamboo-as-a-linux-service-416056046.html

# Create a bamboo.service file in your /etc/systemd/system directory
su bamboo
bash /opt/bamboo-install/atlassian-bamboo-9.6.0/bin/stop-bamboo.sh

sudo su
tee /etc/systemd/system/bamboo.service << EOF
[Unit]
Description=Atlassian Bamboo
After=syslog.target network.target

[Service]
Type=forking
User=bamboo
Environment=CATALINA_PID=/opt/bamboo-install/atlassian-bamboo-9.6.0/bin/Catalina.pid
PIDFile=/opt/bamboo-install/atlassian-bamboo-9.6.0/bin/Catalina.pid
ExecStart=/opt/bamboo-install/atlassian-bamboo-9.6.0/bin/start-bamboo.sh
ExecStop=/opt/bamboo-install/atlassian-bamboo-9.6.0/bin/stop-bamboo.sh
SuccessExitStatus=143

[Install]
WantedBy=multi-user.target
EOF

systemctl enable bamboo.service
systemctl start bamboo.service
systemctl status bamboo.service

-----------------------------------------------------

# setup remote agent:
# install java (jdk, not jre!):
sudo su
apt update && apt install -y openjdk-17-jdk

# set enviroment variables:
cat << EOF >> .profile

export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export PATH=$PATH:$JAVA_HOME/bin
EOF

# Update the  /etc/hosts  file on the bamboo agent:
echo "192.168.0.101   bamboo" >> /etc/hosts

# Create a dedicated user to run Bamboo:
useradd --create-home --home-dir /usr/local/bamboo -p $(perl -e 'print crypt($ARGV[0], "password")' pass123) --shell /bin/bash bamboo

# create agent home folder:
mkdir -p /opt/bamboo-agent-home && cd /opt/bamboo-agent-home
chown bamboo: bamboo-agent-home 

# go on the page to create agent and follow instructions
# it should be like this:

su bamboo       
wget -c http://192.168.0.101:8085/agentServer/agentInstaller/atlassian-bamboo-agent-installer-9.6.0.jar

# to get help:
java -jar atlassian-bamboo-agent-installer-9.6.0.jar
Bamboo URL missing.

Usage: java [<properties>] -jar bamboo-agent.jar <bamboo-url> [<commandString>] [-t <securityToken>]
    where commandString is one of the following:
        console     Run the Bamboo agent in the foreground (default)
        start       Start the Bamboo agent in the background
        stop        Stop the background Bamboo agent
        status      Get the status of the Bamboo agent
        install     Install the Bamboo agent (overwrite any changes to wrapper.conf)
    recognized properties:
        -Dbamboo.home=<bamboo-agent-home>
        -Dbamboo.agent.ignoreServerCertName=(true|false)   Default value is false
        -Dbamboo.allow.empty.artifacts=(true|false)        Default value is false
        -Dbamboo.agent.init.memory=(mb)                    Default value is 256
        -Dbamboo.agent.max.memory=(mb)                     Default value is 512
    Example bamboo-url:         http://bamboo.example.com/agentServer
    Default bamboo-agent-home:  /root/bamboo-agent-home

Security token (if needed) can be obtained from your Bamboo instance under the following address:
    <bamboo-base-url>/admin/agent/addRemoteAgent.action
    
# to first run agent:    
java -Dbamboo.home=/opt/bamboo-agent-home -jar atlassian-bamboo-agent-installer-9.6.0.jar http://192.168.0.101:8085/agentServer/

# check:
bash /opt/bamboo-agent-home/bin/bamboo-agent.sh status
# to stop:
bash /opt/bamboo-agent-home/bin/bamboo-agent.sh stop
# to start:
bash /opt/bamboo-agent-home/bin/bamboo-agent.sh start

# Installing the Bamboo Agent daemon with systemd:
su bamboo
bash /opt/bamboo-agent-home/bin/bamboo-agent.sh stop
sudo su
bash /opt/bamboo-agent-home/bin/bamboo-agent.sh install
systemctl enable bamboo-agent.service
systemctl start bamboo-agent.service
systemctl status bamboo-agent.service

---------------------------------------------------
 
# if you need keygen, take it from https://github.com/haxqer/confluence/releases/

???cd /opt/bamboo-install/
wget -c https://github.com/haxqer/confluence/releases/download/v1.3.3/atlassian-agent.jar
vim /opt/bamboo-install/atlassian-bamboo-9.6.0/bin/setenv.sh
# add this line:
export JAVA_OPTS="-javaagent:/opt/bamboo-install/atlassian-agent.jar ${JAVA_OPTS}"

# keygen license:
# to get help:
java -jar atlassian-agent.jar -h

# from bamboo wrapper take information:
ID: B1LR-ADDJ-J18I-M1QO
Product: bamboo
License type: Bamboo (Data Center)
License email: your_email
Organizaion: my-org

# and paste it as arguments:
java -jar atlassian-agent-jar-with-dependencies.jar -d -m your_email -o my-org -p bamboo -s B1LR-ADDJ-J18I-M1QO


====================================================



===================================================
===================================================

# another way export variables:
vim /etc/environment
PATH="...:/usr/lib/jvm/java-17-openjdk-amd64/bin"
JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
source /etc/environment

# Logs:
cat /opt/bamboo/atlassian-bamboo-9.6.0/logs/catalina.out

# Check:
ss -tlp
ss -tlpn
/usr/lib/jvm/java-17-openjdk-amd64/bin/jps -v

http://localhost:8085

# to change used memory java virtual machine (jvm): 
vim atlassian-bamboo-9.6.0/bin/setenv.sh
: ${JVM_MINIMUM_MEMORY:=1024m}
: ${JVM_MAXIMUM_MEMORY:=1024m}

==============================================================
==============================================================
BAMBOO KEYGEN

==============================================================
1. https://github.com/haxqer/confluence/releases/

wget -c https://github.com/haxqer/confluence/releases/download/v1.3.3/atlassian-agent.jar
vim /opt/bamboo/atlassian-bamboo-9.6.0/bin/setenv.sh
# add this line:
export JAVA_OPTS="-javaagent:/opt/bamboo/atlassian-agent.jar ${JAVA_OPTS}"

# Start Bamboo:
bash /opt/bamboo/atlassian-bamboo-9.6.0/bin/start-bamboo.sh

# keygen license:
# to get help:
java -jar atlassian-agent.jar -h

ID: B1LR-ADDJ-J18I-M1QO
Product: bamboo
License type: Bamboo (Data Center)
License email: your_email
Organizaion: my-org

java -jar atlassian-agent-jar-with-dependencies.jar -d -m dan.rev2021@gmail.com -o my-org -p bamboo -s B1LR-ADDJ-J18I-M1QO

=================================================================

2. https://github.com/ipwnosx/Atlassian-Agent/blob/main/README.md

# Compile jar:
apt update
apt install -y git
apt install -y maven 
cd /opt && mkdir mvn && cd mvn
git init
git clone https://github.com/hgqapp/atlassian-agent.git
cd atlassian-agent/
mvn package

java -jar atlassian-agent-jar-with-dependencies.jar
vim /opt/bamboo/atlassian-bamboo-9.6.0/bin/setenv.sh 
# add this line:
export JAVA_OPTS="-javaagent:/path/to/atlassian-agent.jar ${JAVA_OPTS}"

# Start Bamboo:
bash /opt/bamboo/atlassian-bamboo-9.6.0/bin/start-bamboo.sh

ID: B1LR-ADDJ-J18I-M1QO
Product: bamboo
License type: Bamboo (Data Center)
License email: your email@email.com
Organizaion: my-org

java -jar atlassian-agent-jar-with-dependencies.jar -d -m dan.rev2021@gmail.com -o my-org -p bamboo -s B1LR-ADDJ-J18I-M1QO


==================================================================



